import { useEffect, useState } from "react";
import Head from "next/head";
import { Container, Flex, Heading } from "@chakra-ui/react";
import { SpotifyUser, SpotifyData, Track } from "./api/spotify";
import { SpotifyLogin } from "../features/spotify-login";
import { useSpotifyContext } from "../features/spotify-context";
import { TrackList } from "../features/track-list";
import { CreatePlaylistButton } from "../features/create-playlist";

const Index = () => {
  const [tracks, setTracks] = useState<Track[] | null>(null);
  const [user, setUser] = useState<SpotifyUser | null>(null);
  const { accessToken } = useSpotifyContext();

  useEffect(() => {
    if (!accessToken) {
      return;
    }
    (async () => {
      const res = await fetch(`/api/spotify?token=${accessToken}`);
      const json = (await res.json()) as SpotifyData;
      setUser(json.user);
      setTracks(json.tracks);
    })();
  }, [accessToken]);

  let content = null;
  if (accessToken) {
    content = (
      <>
        <Heading as="h1" size="lg" mb="2">
          Logged in as {user?.display_name}
        </Heading>
        <Heading size="sm">Your top songs for the past four weeks:</Heading>
        {tracks && (
          <>
            <TrackList tracks={tracks} />
            <CreatePlaylistButton tracks={tracks} userId={user?.id} />
          </>
        )}
      </>
    );
  } else {
    content = <SpotifyLogin />;
  }

  return (
    <>
      <Head>
        <title>Spotify Time Warp</title>
        <meta
          name="description"
          content="Autogenerated Spotify playlists based on your listening history"
        />
      </Head>

      <Container maxW="container.xl">
        <Flex direction="column" align="center">
          <Heading as="h1" size="xl" textAlign="center">
            I make Spotify playlists based on your recent listening history.
            Spotify Wrapped, but for the past month.
          </Heading>
        </Flex>
        {content}
      </Container>
    </>
  );
};

export default Index;
