import { useState, useRef, useEffect } from 'react';
import Head from 'next/head';
import { SplashScreen } from '../features/screens/splash';
import { TracksState, TracksScreen } from '../features/screens/tracks';
import { Footer } from '../features/components/footer';
import { useSpotifyContext } from '../features/spotify-context';
import { EndScreen } from '../features/screens/end';
import { Playlist } from '../features/api/spotify';

const Index = () => {
  const tracksRef = useRef<HTMLDivElement | null>(null);
  const endRef = useRef<HTMLDivElement | null>(null);
  const [playlist, setPlaylist] = useState<Playlist | null>(null);
  const [tracksState, setTracksState] = useState<TracksState>(null);
  const { user } = useSpotifyContext();

  const scrollTracksIntoView = () => {
    if (tracksState === 'loaded' && user) {
      tracksRef.current?.scrollIntoView({
        behavior: 'smooth',
        block: 'start',
      });
    }
  };

  const scrollEndIntoView = () => {
    if (playlist) {
      endRef.current?.scrollIntoView({
        behavior: 'smooth',
        block: 'start',
      });
    }
  };

  useEffect(scrollTracksIntoView, [tracksState, user]);
  useEffect(scrollEndIntoView, [playlist]);

  return (
    <>
      <Head>
        <title>Spotify Time Warp</title>
        <meta
          name="description"
          content="Autogenerated Spotify playlists based on your listening history"
        />
      </Head>

      <SplashScreen
        onLoggedInClicked={scrollTracksIntoView}
        tracksState={tracksState}
      />
      <TracksScreen
        onTracksState={setTracksState}
        onPlaylistCreated={setPlaylist}
        onCreatedPlaylistClicked={scrollEndIntoView}
        ref={tracksRef}
      />
      <EndScreen playlist={playlist} ref={endRef} />
      <Footer />
    </>
  );
};

export default Index;
